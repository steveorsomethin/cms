#!/usr/bin/env node
'use strict';

var util = require('util'),
	_ = require('underscore'),
	uuid = require('node-uuid'),
	async = require('async'),
	request = require('request');

var baseUrl = 'http://localhost:8080';
var uuidRegex = /[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}/g,
	uuidReplacement = '00000000-0000-0000-0000-000000000000';
var testResults = {};

var expectResponse = function(testName, statusCode, callback, predicate) {
	return function(error, response, body) {
		var failure,
			jsonBody = typeof body === 'string' ? body : JSON.stringify(body),
			bodyMatches = !predicate || predicate(jsonBody);
		if (error || response.statusCode !== statusCode || !bodyMatches) {
			failure = {
				messages: ['Failed to get expected response']
			};

			if (error) {
				failure.error = error;
			} else {
				if (response.statusCode !== statusCode) {
					failure.messages.push(util.format('Expected status %d but saw %d', statusCode, response.statusCode));
				}
				if (!bodyMatches) {
					failure.messages.push(util.format('Got unexpected response body %s', jsonBody));
				}
			}
		}

		testResults[testName] = failure ? failure : 'SUCCESS';
		callback();
	};
};

var createDocumentType = function(name, documentType, callback) {
		var opt = {method: 'PUT', uri: baseUrl + '/documentTypes/' + name, json: documentType};
		request(opt, callback);
	},
	readDocumentType = function(name, callback) {
		var opt = {
			method: 'GET', 
			uri: baseUrl + '/documentTypes/' + name, 
			headers: {'Accept': 'application/json'}
		};
		request(baseUrl + '/documentTypes/' + name, callback);
	};

var tests = {
	createDocumentTypeSuccess: function(callback) {
		var documentName = this.name,
			documentType = require('./mock/documentTypes/valid.json'),
			expected = expectResponse(this.name, 201, callback, function(body) {
				return body === JSON.stringify(documentType);
			});

		createDocumentType(documentName, documentType, expected);
	},
	createDocumentTypeInvalid: function(callback) {
		var documentName = this.name,
			documentType = require('./mock/documentTypes/invalid.json'),
			error400 = require('./mock/documentTypes/error400.json'),
			expected = expectResponse(this.name, 400, callback, function(body) {
				return body.replace(uuidRegex, uuidReplacement) === JSON.stringify(error400);
			});

		createDocumentType(documentName, documentType, expected);
	},
	readDocumentTypeSuccess: function(callback) {
		var documentName = this.name,
			documentType = require('./mock/documentTypes/valid.json'),
			expected = expectResponse(this.name, 200, callback, function(body) {
				return body === JSON.stringify(documentType);
			});

		createDocumentType(documentName, documentType, function(error, result) {
			readDocumentType(documentName, expected);
		});
	},
	readDocumentTypeNotFound: function(callback) {
		var documentName = this.name,
			error404 = require('./mock/documentTypes/error404.json'),
			expected = expectResponse(this.name, 404, callback, function(body) {
				return body.replace(documentName, 'testName') === JSON.stringify(error404);
			});

		readDocumentType(documentName, expected);
	}
};

//TODO: Fork a process to isolate log events instead of printing them in this context
require("../server/application").run();

//Run tests
async.parallel((function() {
	var tasks = [];
	for (var key in tests) {
		tasks.push(tests[key].bind({name: key}));
	}
	return tasks;
})(), function(error, result) {
	if (error) {
		console.log(error);
	}
	console.log(testResults);
	process.exit();
});

